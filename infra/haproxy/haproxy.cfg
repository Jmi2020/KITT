# HAProxy Load Balancer Configuration for KITTY Gateway
#
# Provides:
# - Load balancing across multiple gateway instances
# - Health checks with automatic failover
# - WebSocket support for real-time research streaming
# - Session affinity for stateful connections
# - High availability (eliminates single point of failure)

global
    log stdout format raw local0 info
    maxconn 4096
    # Disable daemon mode for Docker
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout tunnel 3600000ms  # 1 hour for WebSocket connections

# HAProxy Statistics Dashboard
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:${HAPROXY_STATS_PASSWORD:-changeme}

# Frontend - Public entry point
frontend gateway_frontend
    bind *:8080

    # Health check endpoint (bypass load balancing)
    acl is_health_check path_beg /healthz
    use_backend gateway_health if is_health_check

    # WebSocket detection for research streaming
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl is_websocket_path path_beg /api/research/sessions/

    # Use sticky sessions for WebSocket connections
    use_backend gateway_websocket if is_websocket or is_websocket_path

    # Default backend for HTTP requests
    default_backend gateway_http

# Backend - HTTP requests (round-robin load balancing)
backend gateway_http
    balance roundrobin

    # Health check configuration
    option httpchk GET /healthz
    http-check expect status 200

    # Gateway instances (scaled via docker-compose)
    server gateway1 gateway:8080 check inter 2000ms rise 2 fall 3
    server gateway2 gateway:8080 check inter 2000ms rise 2 fall 3
    server gateway3 gateway:8080 check inter 2000ms rise 2 fall 3

# Backend - WebSocket connections (source IP hash for session affinity)
backend gateway_websocket
    balance source  # Sticky sessions based on client IP
    hash-type consistent

    # Health check configuration
    option httpchk GET /healthz
    http-check expect status 200

    # Enable WebSocket protocol upgrade
    option http-server-close
    option forceclose
    no option httpclose

    # Gateway instances
    server gateway1 gateway:8080 check inter 2000ms rise 2 fall 3
    server gateway2 gateway:8080 check inter 2000ms rise 2 fall 3
    server gateway3 gateway:8080 check inter 2000ms rise 2 fall 3

# Backend - Direct health check (no load balancing)
backend gateway_health
    balance roundrobin
    server gateway1 gateway:8080 check
    server gateway2 gateway:8080 check
    server gateway3 gateway:8080 check
