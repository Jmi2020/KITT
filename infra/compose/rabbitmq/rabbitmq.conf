# RabbitMQ Configuration
#
# This configuration file sets up RabbitMQ for KITT's message queue infrastructure.
# It includes settings for performance, reliability, and monitoring.

# ============================================================================
# Listeners
# ============================================================================

listeners.tcp.default = 5672
management.tcp.port = 15672

# ============================================================================
# Memory & Disk Thresholds
# ============================================================================

# Memory high watermark (60% of available RAM)
vm_memory_high_watermark.relative = 0.6

# Paging threshold (50% of memory limit)
vm_memory_high_watermark_paging_ratio = 0.5

# Minimum free disk space before RabbitMQ blocks producers
disk_free_limit.absolute = 2GB

# ============================================================================
# Message Persistence
# ============================================================================

# Queue master location strategy
queue_master_locator = min-masters

# Lazy queues (move messages to disk to reduce memory usage)
# Note: queue_lazy_mode is deprecated in RabbitMQ 3.12+
# Use queue.lazy policy or x-queue-mode header instead

# ============================================================================
# Connection & Channel Limits
# ============================================================================

# Maximum number of channels per connection
channel_max = 2048

# Heartbeat timeout (seconds)
heartbeat = 60

# Connection timeout
handshake_timeout = 10000

# ============================================================================
# Clustering (for future multi-node setup)
# ============================================================================

# Cluster partition handling
# Options: ignore, pause_minority, pause_if_all_down, autoheal
cluster_partition_handling = autoheal

# ============================================================================
# Management Plugin
# ============================================================================

# Enable management plugin
management.load_definitions = /etc/rabbitmq/definitions.json

# Management UI path prefix
management.path_prefix = /rabbitmq

# Sample retention for metrics
# Note: These are configured via definitions.json instead

# ============================================================================
# Prometheus Metrics
# ============================================================================

# Enable Prometheus plugin
prometheus.tcp.port = 15692
prometheus.return_per_object_metrics = true

# ============================================================================
# Logging
# ============================================================================

# Log levels: debug, info, warning, error, critical, none
log.console.level = info
log.file.level = info

# Log format
log.console.formatter = json
log.file.formatter = json

# ============================================================================
# Default User & VHost
# ============================================================================

# Default user (overridden by environment variables)
# default_user = kitty
# default_pass = changeme
# default_vhost = /

# ============================================================================
# Message TTL & Length Limits
# ============================================================================

# Default message TTL (milliseconds) - disabled by default
# Messages can set individual TTLs
# message_ttl = 3600000

# Max message size (bytes)
max_message_size = 134217728  # 128MB

# ============================================================================
# Queue Length Limits
# ============================================================================

# Default max queue length - disabled by default
# Individual queues can set their own limits
# queue_max_length = 1000000

# ============================================================================
# Consumer Timeout
# ============================================================================

# Cancel consumers after N milliseconds of inactivity
# Disabled by default (0 = no timeout)
consumer_timeout = 1800000  # 30 minutes

# ============================================================================
# Background GC
# ============================================================================

# Interval between GC runs
background_gc_target_interval = 60000

# ============================================================================
# Stats Collection
# ============================================================================

# Collect statistics (required for management UI)
# Valid values: none, coarse, fine
collect_statistics = coarse
collect_statistics_interval = 5000

# ============================================================================
# TCP Listen Options
# ============================================================================

tcp_listen_options.backlog = 4096
tcp_listen_options.nodelay = true
tcp_listen_options.linger.on = true
tcp_listen_options.linger.timeout = 0
tcp_listen_options.exit_on_close = false
