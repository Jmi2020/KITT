# ==============================================================================
# KITTY Tool Registry
# ==============================================================================
# Central registry for all MCP tools with metadata, safety levels, and permissions
#
# Tool Definition Structure:
#   tool_name:
#     server: MCP server name (research, cad, homeassistant, memory, vision, broker)
#     description: Human-readable description
#     hazard_class: none | low | medium | high
#     requires_confirmation: true | false
#     budget_tier: free | paid | premium
#     enabled: true | false (optional, defaults to true)
#
# Hazard Classes:
#   - none: No safety concerns (web search, reading data)
#   - low: Minimal impact (CAD generation, memory storage)
#   - medium: Reversible actions (device control, print queue)
#   - high: Irreversible/dangerous (unlock doors, enable power)
#
# Budget Tiers:
#   - free: Local/free external APIs
#   - paid: Cloud LLM routing (Perplexity, GPT)
#   - premium: Expensive external services (Zoo CAD, Tripo)

version: 1

tools:
  # ==============================================================================
  # Research Tools (free, no hazards)
  # ==============================================================================

  web_search:
    server: research
    description: "Search the web for current information using SearXNG, Brave, or DuckDuckGo"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true

  fetch_webpage:
    server: research
    description: "Fetch and parse webpage content with Jina Reader or BeautifulSoup"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true

  research_deep:
    server: research
    description: "Deep research using Perplexity Sonar for comprehensive answers (paid API)"
    hazard_class: none
    requires_confirmation: false
    budget_tier: paid
    enabled: true
    requires_override: true  # Requires API_OVERRIDE_PASSWORD

  # ==============================================================================
  # Vision Tools (free, no hazards)
  # ==============================================================================

  image_search:
    server: vision
    description: "Search for images using DuckDuckGo or Google Images API"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true

  image_filter:
    server: vision
    description: "Filter and rank images using CLIP embeddings for relevance"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true

  store_selection:
    server: vision
    description: "Store selected images to MinIO for CAD reference or documentation"
    hazard_class: low
    requires_confirmation: false
    budget_tier: free
    enabled: true

  # ==============================================================================
  # Memory Tools (free, low hazard)
  # ==============================================================================

  remember:
    server: memory
    description: "Store information in long-term memory (Qdrant vector database)"
    hazard_class: low
    requires_confirmation: false
    budget_tier: free
    enabled: true

  search_memories:
    server: memory
    description: "Search long-term memory for relevant past conversations or facts"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true

  # ==============================================================================
  # CAD Tools (paid/premium, low-medium hazard)
  # ==============================================================================

  cad.generate_model:
    server: cad
    description: "Generate CAD model using Zoo.dev KittyCAD API (parametric)"
    hazard_class: low
    requires_confirmation: false
    budget_tier: premium
    enabled: true
    requires_override: true  # Requires API_OVERRIDE_PASSWORD for paid service

  cad.image_to_mesh:
    server: cad
    description: "Convert image to 3D mesh using Tripo AI (paid API)"
    hazard_class: low
    requires_confirmation: false
    budget_tier: premium
    enabled: true
    requires_override: true

  cad.local_generate:
    server: cad
    description: "Generate CAD locally using CadQuery or FreeCAD scripts"
    hazard_class: low
    requires_confirmation: false
    budget_tier: free
    enabled: true

  # ==============================================================================
  # Fabrication Tools (low-medium hazard - slicer app launching)
  # ==============================================================================

  fabrication.open_in_slicer:
    server: broker
    description: "Open STL model in appropriate slicer app based on size and printer availability (MANUAL WORKFLOW - DEFAULT)"
    hazard_class: low
    requires_confirmation: false
    budget_tier: free
    enabled: true
    note: |
      Priority hierarchy:
      1. CNC/laser jobs → Luban (Snapmaker only multi-mode)
      2. Models ≤250mm + Bamboo idle → BambuStudio (best quality)
      3. Models ≤250mm + Bamboo busy → ElegySlicer (fallback)
      4. Models >250mm (up to 800mm) → ElegySlicer (Elegoo Giga)

      Parameters:
      - stl_path (required): Path to STL/CAM file
      - mode (optional): "3d_print" (default), "cnc", or "laser"

      Returns printer selection, app name, and reasoning message.
      User completes slicing and printing in the application.

  fabrication.prepare_print:
    server: broker
    description: "Automatic workflow: scale model, check orientation, detect supports, then open in slicer (AUTOMATIC WORKFLOW - PHASE 2)"
    hazard_class: medium
    requires_confirmation: true
    confirmation_phrase: "Confirm: proceed"
    budget_tier: free
    enabled: false
    note: |
      Phase 2 feature requiring vision server integration.

      Workflow:
      1. Ask user for target model height
      2. Scale STL to fit requirements and printer
      3. Call vision server to analyze orientation
      4. Call vision server to detect support needs
      5. Save scaled/rotated STL
      6. Open in slicer with recommendations

      Parameters:
      - stl_path (required): Path to STL file
      - target_height (optional): Desired model height in mm
      - auto_orient (optional): Apply automatic orientation (default: ask user)
      - mode (optional): "3d_print" (default), "cnc", or "laser"

  fabrication.analyze_model:
    server: broker
    description: "Analyze STL dimensions and recommend printer without opening slicer"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true
    note: |
      Returns model dimensions, volume, recommended printer, and reasoning.
      Useful for batch analysis or decision preview before opening slicer.

      Parameters:
      - stl_path (required): Path to STL file

  fabrication.printer_status:
    server: broker
    description: "Check status of all printers (idle, printing, offline)"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true
    note: |
      Queries printer status via MQTT (Bamboo) and HTTP (Elegoo).
      Returns: {"bamboo_h2d": {"status": "idle", ...}, "elegoo_giga": {...}, ...}
      Status cached for 30 seconds to reduce network calls.

  # ==============================================================================
  # Network Discovery Tools (free, no hazards - device detection)
  # ==============================================================================

  discovery.scan_network:
    server: broker
    description: "Trigger network discovery scan to find IoT devices (printers, Raspberry Pi, ESP32)"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true
    note: |
      Scans local network using multiple methods:
      - mDNS/Bonjour: Discovers devices advertising services
      - SSDP/UPnP: Finds smart home devices and network printers
      - Bamboo Labs UDP: Direct printer discovery (port 2021)
      - Snapmaker UDP: CNC/laser machine discovery (port 20054)

      Parameters:
      - methods (optional): Array of methods to use
      - timeout_seconds (optional): Scan timeout (default: 30)

      Returns scan_id for status tracking. Typical scan time: 12-30 seconds.

  discovery.list_devices:
    server: broker
    description: "List all discovered devices with optional filtering by type or approval status"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true
    note: |
      Lists devices from discovery registry with filters:
      - device_type: printer_3d, raspberry_pi, esp32, etc.
      - approved: true/false (user approval status)
      - is_online: true/false (current connectivity)
      - limit: Max results (default: 100)

      Returns device list with IP addresses, hostnames, manufacturers, models.
      Devices must be approved before integration.

  discovery.find_printers:
    server: broker
    description: "Find all 3D printers, CNC mills, and laser engravers on the network"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true
    note: |
      Specialized search for fabrication equipment.
      Returns all devices categorized as printer_3d, printer_cnc, or printer_laser.
      Includes approval status and online state.

  discovery.approve_device:
    server: broker
    description: "Approve a discovered device for integration and control"
    hazard_class: low
    requires_confirmation: true
    confirmation_phrase: "Confirm: approve"
    budget_tier: free
    enabled: true
    note: |
      User approval workflow for discovered devices.
      Once approved, device can be used by fabrication and other services.

      Parameters:
      - device_id (required): Device UUID from discovery.list_devices
      - notes (optional): User notes about device

      Approval is required before KITTY can control the device.

  # ==============================================================================
  # Home Assistant Tools (medium-high hazard - physical control)
  # ==============================================================================

  homeassistant.turn_on:
    server: homeassistant
    description: "Turn on a Home Assistant entity (light, switch, etc.)"
    hazard_class: low
    requires_confirmation: false
    budget_tier: free
    enabled: true

  homeassistant.turn_off:
    server: homeassistant
    description: "Turn off a Home Assistant entity (light, switch, etc.)"
    hazard_class: low
    requires_confirmation: false
    budget_tier: free
    enabled: true

  homeassistant.activate_scene:
    server: homeassistant
    description: "Activate a Home Assistant scene (lighting preset)"
    hazard_class: low
    requires_confirmation: false
    budget_tier: free
    enabled: true

  homeassistant.unlock_door:
    server: homeassistant
    description: "Unlock smart lock via Home Assistant"
    hazard_class: high
    requires_confirmation: true
    confirmation_phrase: "Confirm: proceed"
    requires_signature: true
    budget_tier: free
    enabled: true
    note: "HIGH RISK: Unlocking doors has security implications. Requires signature verification."

  homeassistant.lock_door:
    server: homeassistant
    description: "Lock smart lock via Home Assistant"
    hazard_class: medium
    requires_confirmation: false
    budget_tier: free
    enabled: true

  homeassistant.enable_power:
    server: homeassistant
    description: "Enable high-power equipment (laser cutter, welder, etc.)"
    hazard_class: high
    requires_confirmation: true
    confirmation_phrase: "Confirm: proceed"
    requires_signature: true
    budget_tier: free
    enabled: true
    note: "HIGH RISK: Enabling dangerous equipment. Requires signature verification and zone presence check."

  # ==============================================================================
  # Command Broker Tools (system-level, medium hazard)
  # ==============================================================================

  broker.execute_command:
    server: broker
    description: "Execute system command via command broker with audit logging"
    hazard_class: medium
    requires_confirmation: true
    confirmation_phrase: "Confirm: proceed"
    budget_tier: free
    enabled: false  # Disabled by default for safety
    note: "System-level command execution. Enable only in controlled environments."

  # ==============================================================================
  # Reasoning Delegation (for dual-model architecture)
  # ==============================================================================

  reason_with_f16:
    server: reasoning
    description: "Delegate complex reasoning to F16 high-precision model (Llama 3.3 70B)"
    hazard_class: none
    requires_confirmation: false
    budget_tier: free
    enabled: true
    note: "Used by Q4 agent to request deep analysis from F16 reasoning engine."

# ==============================================================================
# Tool Categories (for UI/CLI filtering)
# ==============================================================================

categories:
  research: [web_search, fetch_webpage, research_deep]
  vision: [image_search, image_filter, store_selection]
  memory: [remember, search_memories]
  cad: [cad.generate_model, cad.image_to_mesh, cad.local_generate]
  fabrication: [fabrication.open_in_slicer, fabrication.prepare_print, fabrication.analyze_model, fabrication.printer_status]
  discovery: [discovery.scan_network, discovery.list_devices, discovery.find_printers, discovery.approve_device]
  homeassistant: [homeassistant.turn_on, homeassistant.turn_off, homeassistant.activate_scene, homeassistant.unlock_door, homeassistant.lock_door, homeassistant.enable_power]
  broker: [broker.execute_command]
  reasoning: [reason_with_f16]

# ==============================================================================
# Safety Policies (global overrides)
# ==============================================================================

safety:
  # Require confirmation phrase for all hazard_class: high tools
  enforce_high_hazard_confirmation: true

  # Require API_OVERRIDE_PASSWORD for all budget_tier: paid/premium tools
  enforce_paid_override: true

  # Require signature verification for tools with requires_signature: true
  enforce_signature_verification: true

  # Default confirmation phrase (can be overridden per-tool)
  default_confirmation_phrase: "Confirm: proceed"

  # Enable audit logging for all tool executions
  audit_enabled: true
